<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CI - PHP</title>
  <link rel="stylesheet" href="styles.css" charset="utf-8">
  <link rel="stylesheet" href="../tools/slide/transitions.css" media="screen" charset="utf-8">
  <link rel="import" href="../tools/slide/web-presentation.html">
  <link href="../tools/syntaxHighlight/prism.css" rel="stylesheet"/>
</head>
<body>
  <web-presentation>
    <web-presentation-progress></web-presentation-progress>
    <web-presentation-keyboardcontrols></web-presentation-keyboardcontrols>

    <web-slide-title data-transition="moveFromBottom">
      <h1>CI - PHP Maven project</h1>
      <h2>How to do a CI for a PHP project</h2>
      <br/>
      <h2>Tools: Jenkins, Maven, Composer</h2>
      <p><small>Press Space to continue</small></p>
    </web-slide-title>
    
    <web-slide data-transition="moveToLeft">
      <h1>Introduction</h1>
      <h2>The theory: <a href="../ci-basics/index.html">read the article</a></h2>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Introduction - Tools</h1>
      <h2>
      	<ul>
      		<li>Maven</li>
      		<li>Jenkins</li>
      	</ul>
      </h2>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Maven - Intro</h1>
	  <p>Apache Maven is a software project management and comprehension tool. Based on the concept of a project object model (POM), Maven can manage a project's build, reporting and documentation from a central piece of information.
	  	<br/>
	  	<br/>
	  	<a href="https://maven.apache.org/">Official website</a>
	  </p>
	  <img src="../logos/maven.png"/>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Maven - Intro</h1>
      <ul>
      	<li>Made for java projects but highly adaptable</li>
      	<li>Most of the project configuration is inside a pom.xml file inside the project</li>
      	<li>Introduce a Build Lifecycle</li>
      </ul>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Maven - Build Lifecycle</h1>
      <ul>
      	<li>validate - validate the project is correct and all necessary information is available</li><br/>
		<li>compile - compile the source code of the project</li><br/>
		<li>test - test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed</li><br/>
		<li>package - take the compiled code and package it in its distributable format, such as a JAR.</li><br/>
		<li>verify - run any checks on results of integration tests to ensure quality criteria are met</li><br/>
		<li>install - install the package into the local repository, for use as a dependency in other projects locally</li><br/>
		<li>deploy - done in the build environment, copies the final package to the remote repository for sharing with other developers and projects.</li><br/>
      </ul>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Jenkins - Intro</h1>
	  <h2>Build great things at any scale</h2>
	  <p>The leading open source automation server, Jenkins provides hundreds of plugins to support building, deploying and automating any project.</p>
      <img src="../logos/jenkins.png"/>
    </web-slide>
    
    <web-slide data-transition="moveFromBottom">
      <h1>Jenkins - Leaderboard</h1>
      <img src="./pictures/jenkins-leaderboard.png" style="width:100%"/">
    </web-slide>
    
    <web-slide data-transition="moveFromBottom">
      <h1>Pre-requisites</h1>
      <ul>
      	<li>A server for CI</li>
      	<li>Jenkins, Maven and maybe other tools installed on this server</li>
      	<li>A development server which will be the target of the deployed product</li>
      	<li>(optional) Maven installed on the current machine to create the package locally before making it on jenkins</li>
      </ul>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Remember the phases</h2>
	  <img src="../ci-basics/pictures/flowcharts/ci.png"/>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 0 - Init the project inside pom.xml</h2>
      <pre style="width:50%"><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.fakeproject&lt;/groupId&gt;
    &lt;artifactId&gt;helloworld&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;Hello World&lt;/name&gt;
	&lt;build&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 1 - SCM</h2>
	  Getting the code from SCM is a part of Jenkins' job. We will do that later.
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 2 - Get the libs</h2>
	  <p>Put all the commands you need to download libraries inside a shell script in the project. The script will be run before the compilation phase of Maven.</p>
	  <pre style="width:85%"><code class="language-xml">
&lt;build&gt;
   ...	
	&lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
            &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
            &lt;version&gt;1.6.0&lt;/version&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;Prepare phase&lt;/id&gt;
                    &lt;phase&gt;generate-sources&lt;/phase&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;exec&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;configuration&gt;
                        &lt;executable&gt;${basedir}/scripts/prepare/prepare.sh&lt;/executable&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;
    ...</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 2' - Tells Maven where the sources are</h2>
	  <p>As it is not a Java project, you have to tell Maven the sources location.
	  We must exclude the Maven's working directory (aka target) and some files used or generated by Maven.
	  </p>
	  <pre style="width:85%"><code class="language-xml">
    &lt;build&gt;
    ...
        &lt;resources&gt;
            &lt;resource&gt;
                &lt;directory&gt;.&lt;/directory&gt;
                &lt;excludes&gt;
                    &lt;exclude&gt;target/**&lt;/exclude&gt;
                    &lt;exclude&gt;pom.xml&lt;/exclude&gt;
                    &lt;exclude&gt;pom.xml.releaseBackup&lt;/exclude&gt;
                    &lt;exclude&gt;pom.xml.tag&lt;/exclude&gt;
                    &lt;exclude&gt;release.properties&lt;/exclude&gt;
                &lt;/excludes&gt;
            &lt;/resource&gt;
        &lt;/resources&gt;
    ...</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 3 - The compilation</h2>
	  <p>There are no real compilation in a PHP project. So, tell that to Maven
	  </p>
	  <pre style="width:85%"><code class="language-xml">
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.7.0&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;default-compile&lt;/id&gt;
                        &lt;phase&gt;none&lt;/phase&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
    ...</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 4 - Tests</h2>
	  <p>You can reuse the maven exec plugin to run a sell script in charge of running tests (like in phase 2 when getting the libs) or call a bash command. This is an example of running directly a bash command: 
	  </p>
	  <pre style="width:85%"><code class="language-xml">
&lt;execution&gt;
    &lt;id&gt;phpunit&lt;/id&gt;
    &lt;phase&gt;test&lt;/phase&gt;
    &lt;configuration&gt;
        &lt;executable&gt;phpunit&lt;/executable&gt;
        &lt;arguments&gt;
            &lt;argument&gt;--log-junit&lt;/argument&gt;
            &lt;argument&gt;${basedir}/target/results/phpunit/phpunit.xml&lt;/argument&gt;
            &lt;argument&gt;-c&lt;/argument&gt;
            &lt;argument&gt;${basedir}/phpunit.xml.dist&lt;/argument&gt;
        &lt;/arguments&gt;
    &lt;/configuration&gt;
    &lt;goals&gt;
        &lt;goal&gt;exec&lt;/goal&gt;
    &lt;/goals&gt;
&lt;/execution&gt;
    ...</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 5 - Package: Make the rpm</h2>
	  <p>Use the <a href="http://www.mojohaus.org/rpm-maven-plugin/">Maven rpm plugin</a> which is plugged by default on the Maven's package phase.<br/>
	  Note: I won't describe how works a RPM. The only thing you you have to know is that a RPM is a kind of executable and one of its tasks is to move source code to a predefined destination (see the mapping tag). 
	  </p>
	  <pre style="width:85%"><code class="language-xml">
 &lt;plugin&gt;
     &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
     &lt;artifactId&gt;rpm-maven-plugin&lt;/artifactId&gt;
     &lt;version&gt;2.1.5&lt;/version&gt;
     &lt;extensions&gt;true&lt;/extensions&gt;
     &lt;executions&gt;
         &lt;execution&gt;
             &lt;id&gt;generate-rpm&lt;/id&gt;
             &lt;goals&gt;
                 &lt;goal&gt;rpm&lt;/goal&gt;
             &lt;/goals&gt;
         &lt;/execution&gt;
     &lt;/executions&gt;
     &lt;configuration&gt;
         &lt;license&gt;MIT&lt;/license&gt;
         &lt;distribution&gt;DISTRIBUTION&lt;/distribution&gt;
         &lt;group&gt;benjdum59&lt;/group&gt;
         &lt;packager&gt;benjdum59&lt;/packager&gt;
         &lt;defineStatements&gt;
             &lt;defineStatement&gt;_unpackaged_files_terminate_build 0&lt;/defineStatement&gt;
                  &lt;defineStatement&gt;_binaries_in_noarch_packages_terminate_build 0&lt;/defineStatement&gt;
         &lt;/defineStatements&gt;
         &lt;mappings&gt;
             &lt;mapping&gt;
                 &lt;directory&gt;/var/www/${project.artifactId}&lt;/directory&gt;
                 &lt;filemode&gt;755&lt;/filemode&gt;
                 &lt;username&gt;apache&lt;/username&gt;
                 &lt;groupname&gt;apache&lt;/groupname&gt;
                      &lt;configuration&gt;noreplace&lt;/configuration&gt;
                 &lt;directoryIncluded&gt;true&lt;/directoryIncluded&gt;
                 &lt;sources&gt;
                     &lt;source&gt;
                         &lt;location&gt;target/classes&lt;/location&gt;
                     &lt;/source&gt;
                 &lt;/sources&gt;
             &lt;/mapping&gt;
         &lt;/mappings&gt;
     &lt;/configuration&gt;
 &lt;/plugin&gt;</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 5' - Package: Make the rpm - post installation</h2>
	  <p>
	  	RPM can run scripts before and after the installation. Create a post-install script containing all you need (e.g.: Clear cache, database migration...). 
	  	As scripts may differ for a development and a production environment, you may use different scripts and call the one you need using the environment variable.
	  </p>
	  <pre style="width:85%"><code class="language-xml">
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
...
    &lt;packaging&gt;rpm&lt;/packaging&gt;
    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;environment&gt;stg&lt;/environment&gt;
    &lt;/properties&gt;
...
	  &lt;!-- RPM Part --&gt;
         &lt;/mappings&gt;
         &lt;postinstallScriptlet&gt;
              &lt;scriptFile&gt;./scripts/post-install/post-install-${environment}.sh&lt;/scriptFile&gt;
              &lt;fileEncoding&gt;utf-8&lt;/fileEncoding&gt;
         &lt;/postinstallScriptlet&gt;
     &lt;/configuration&gt;</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Test your package generation</h2>
	  <p>
	  	Default value of environment is "stg" (from the example).
	  </p>
	  <pre style="width:85%"><code class="language-bash">	  mvn clean package
	  #OR
	  mvn clean package -Denvironement=stg #does the same thing
	  #OR
	  mvn clean package -Denvironment=prod 
	  #make sure you have ./scripts/post-install/post-install-prod.sh file
</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Intermediate phase: send rpm to a product browser</h2>
	  <p>
	  	Nexus is a great tool for product storage and is well plugged with Maven.<br/>
	  	You have to set the repository informations (url, authentication) in the settings.xml file (in Maven installation or homeDirectory/.m2) and configure the project to use this repository.
	  </p>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Intermediate phase: send rpm to a product browser</h2>
      <h2>settings.xml</h2>
	  <pre style="width:85%"><code class="language-xml">&lt;?xml version="1.0"?&gt;
&lt;settings&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;myprofile&lt;/id&gt;
      &lt;repositories&gt;
        &lt;repository&gt;
          &lt;id&gt;private-snapshot&lt;/id&gt;
          &lt;url&gt;https://nexus.host.fr/nexus/content/repositories/private-snapshot/&lt;/url&gt;
          &lt;releases&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/snapshots&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
  &lt;activeProfiles&gt;
    &lt;activeProfile&gt;myprofile&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
  &lt;servers&gt;
   &lt;server&gt;
      &lt;id&gt;private-snapshot&lt;/id&gt;
      &lt;username&gt;benjdum59&lt;/username&gt;
      &lt;password&gt;password&lt;/password&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
&lt;/settings&gt;</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Intermediate phase: send rpm to a product browser</h2>
      <h2>pom.xml</h2>
	  <pre style="width:85%"><code class="language-xml">&lt;/build&gt;
&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;default&lt;/id&gt;
        &lt;activation&gt;
            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
        &lt;/activation&gt;
    	&lt;distributionManagement&gt;
            &lt;repository&gt;
                &lt;id&gt;private-releases&lt;/id&gt;
                &lt;url&gt;https://nexus.host.fr/nexus/content/repositories/private-release/&lt;/url&gt;
            &lt;/repository&gt;
            &lt;snapshotRepository&gt;
                &lt;id&gt;private-snapshots&lt;/id&gt;
                &lt;url&gt;https://nexus.host.fr/nexus/content/repositories/private-snapshot&lt;/url&gt;
            &lt;/snapshotRepository&gt;
        &lt;/distributionManagement&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Intermediate phase: send rpm to a product browser</h2>
      <h2>Upload rpm</h2>
	  <pre style="width:85%"><code class="language-bash">mvn clean deploy -Denvironment="stg"</code></pre>
	  <h2>Note: All Maven phases will be run (compile, test, package) before deploy.</h2>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Project configuration for CI</h1>
      <h2>Phase 6 - Deploy the product on a development environment</h2>
      <p>This part is done with Jenkins. We will see it later.</p>
    </web-slide>
    
    <web-slide data-transition="moveFromBottom">
      <h1>End of Project configuration</h1>
      <div id="graphDiv"  style="width:100%; height:50%; background-color: #DAE4E4;">
	    <img 
    			src="pictures/flowcharts/ic-end-project-configuration.svg" 
    			alt="CI Flow Chart"
    			height="200px"
    			width="100%" />

  		</div>
  	</web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Jenkins configuration - New job</h1>
      <h2>Create a new Maven job</h2>
      <img src="./pictures/jenkins-newjob.png" style="width:80%"/>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Jenkins configuration - Configure development environment for Jenkins</h1>
      <h2>Install plugin "Publish Over SSH" and configure the development server to accept jenkins' public ssh key</h2>
      <img src="./pictures/jenkins-publish-over-ssh.png" style="height:50%"/>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Jenkins configuration - Configure SCM in job</h1>
      <img src="./pictures/jenkins-configure-scm.png" style="height:80%"/>
    </web-slide>
    
    <web-slide data-transition="moveToLeft">
      <h1>Jenkins configuration - Trigger build</h1>
      <img src="./pictures/jenkins-trigger-build.png" style="height:80%"/>
    </web-slide>


    
  </web-presentation>
  <script src="../tools/syntaxHighlight/prism.js"></script>
  <script src="https://use.fontawesome.com/c05a9d6e77.js"></script>
</body>
</html>
